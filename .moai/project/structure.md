# MoAI-ADK (Go Edition) - Architecture and Structure Document

## Overall Architecture

### Architecture Pattern

MoAI-ADK follows a **Modular Monolithic** architecture with clear Domain-Driven Design (DDD) boundaries. The application compiles into a single binary while maintaining strict module separation through Go's package system and the `internal/` visibility boundary.

### Design Principles

1. **Separation of Concerns**: Each domain (CLI, config, Git, LSP, quality) lives in its own package with explicit public interfaces.
2. **Dependency Inversion**: Core business logic depends on interfaces, not concrete implementations. External libraries are wrapped behind Go interfaces.
3. **Privacy by Default**: The `internal/` directory ensures implementation details cannot be imported by external consumers.
4. **Explicit over Implicit**: Go's explicit error handling, interface satisfaction, and package imports make dependencies visible and traceable.
5. **Issue-Driven Design**: Architecture decisions are directly informed by 173 GitHub issues and 4,174 git commits from the Python predecessor. Every new module addresses documented pain points.
6. **Zero Runtime Template Expansion**: JSON and YAML configuration files are generated programmatically via Go struct serialization (json.Marshal, yaml.Marshal). No dynamic tokens ($VAR, {{VAR}}, ${SHELL}) are ever written to configuration files. This eliminates the compile-time vs runtime gap that caused 4 regression cycles in the Python predecessor.
7. **Single Source of Path Truth**: All file paths in deployed artifacts (settings.json, agent definitions, template files) are generated by a single set of functions in `internal/template/`. Path construction never happens via string concatenation outside this package. All paths pass through `filepath.Clean()` and directory containment checks before deployment.

### Architectural Layers

```
+--------------------------------------------------+
|                   cmd/moai/                        |
|               (CLI Entry Point)                   |
+--------------------------------------------------+
                        |
+--------------------------------------------------+
|                  internal/cli/                    |
|            (Command Definitions - Cobra)          |
|        includes: hook dispatcher subcommands      |
+--------------------------------------------------+
     |       |         |         |        |     |
+----+-------+---------+---------+--------+-----+--+
| hook/  | config/ | core/   | merge/ | update/ ..|
| (Claude| (Custom | (DDD    | (3-Way | (Self-    |
|  Code  |  YAML   | Domains)| Merge) |  Update)  |
|  Hooks)| loader) |         |        |           |
+--------+---------+---------+--------+-----------+
     |                  |                    |
+----+------------------+--------------------+-----+
| manifest/ | template/ | lsp/   | loop/  | ...  |
| (File     | (go:embed | (LSP)  | (Ralph)|      |
|  Tracking)|  Deploy)  |        |        |      |
+-----------+-----------+--------+--------+------+
                        |
+--------------------------------------------------+
|                    pkg/                           |
|         (Public Models, Utils, Version)           |
+--------------------------------------------------+
```

---

## Directory Structure

```
moai-adk-go/
├── cmd/
│   └── moai/
│       └── main.go
├── internal/
│   ├── astgrep/                    # AST-Grep integration
│   │   ├── analyzer.go
│   │   ├── models.go
│   │   └── rules.go
│   ├── cli/                        # Cobra CLI commands
│   │   ├── cc.go                   #   Claude Code integration commands
│   │   ├── deps.go                 #   Dependency injection and wiring
│   │   ├── doctor.go
│   │   ├── glm.go                  #   GLM (Go Language Model) commands
│   │   ├── hook.go                 #   Hook dispatcher (moai hook <event>)
│   │   ├── init.go
│   │   ├── rank.go
│   │   ├── root.go
│   │   ├── status.go
│   │   ├── statusline.go           #   Statusline rendering command
│   │   ├── update.go
│   │   ├── version.go              #   Version display command
│   │   └── worktree/
│   │       ├── clean.go
│   │       ├── list.go
│   │       ├── new.go
│   │       ├── remove.go
│   │       ├── root.go             #   Worktree root command registration
│   │       ├── switch.go
│   │       └── sync.go
│   ├── config/                     # Configuration management (custom YAML loader)
│   │   ├── defaults.go             #   Compiled default values
│   │   ├── errors.go               #   Configuration error types
│   │   ├── loader.go               #   Custom YAML section loader
│   │   ├── manager.go              #   Central config with sync.RWMutex
│   │   ├── types.go                #   Config struct definitions with defaults
│   │   └── validation.go           #   Schema validation
│   ├── defs/                       # Constant definitions (6 files)
│   │   └── specid.go               #   SPEC ID parsing and validation
│   ├── core/                       # Core business logic domains
│   │   ├── git/                    #   Git domain (system Git via exec)
│   │   │   ├── branch.go
│   │   │   ├── conflict.go
│   │   │   ├── doc.go
│   │   │   ├── errors.go
│   │   │   ├── event.go
│   │   │   ├── manager.go
│   │   │   ├── types.go
│   │   │   └── worktree.go
│   │   ├── project/
│   │   │   ├── detector.go
│   │   │   ├── errors.go
│   │   │   ├── initializer.go
│   │   │   ├── methodology_detector.go
│   │   │   ├── phase.go
│   │   │   └── validator.go
│   │   └── quality/
│   │       ├── trust.go
│   │       └── validators.go
│   ├── foundation/                 # Foundation methodologies
│   │   ├── doc.go
│   │   ├── ears.go                 #   EARS requirement patterns
│   │   ├── errors.go
│   │   ├── language.go             #   Language ecosystem definitions (16+ languages)
│   │   ├── methodology.go          #   Development methodology patterns
│   │   └── trust5.go               #   TRUST 5 principle definitions and checklists
│   ├── github/                     # GitHub API integration (20 files)
│   │   ├── gh.go                   #   GitHub CLI wrapper (gh command)
│   │   ├── issue_closer.go         #   Automated GitHub issue closing
│   │   ├── issue_parser.go         #   Issue content parsing
│   │   ├── pr_merger.go            #   Pull request merge automation
│   │   ├── pr_reviewer.go          #   PR review automation
│   │   ├── spec_linker.go          #   Link SPECs to GitHub issues/PRs
│   │   └── worktree_orchestrator.go#   Worktree-based PR workflows
│   ├── hook/                       # Hook system (replaces 46 Python scripts)
│   │   ├── auto_update.go          #   Auto-update hook handler
│   │   ├── compact.go              #   Context preservation
│   │   ├── contract.go             #   Hook execution contract
│   │   ├── doc.go
│   │   ├── errors.go
│   │   ├── notification.go         #   Notification hook handler
│   │   ├── permission_request.go   #   Permission request hook handler
│   │   ├── post_tool.go            #   Linter, formatter, LSP diagnostics
│   │   ├── post_tool_failure.go    #   Post-tool failure handler
│   │   ├── pre_tool.go             #   Security guard, validation
│   │   ├── protocol.go             #   Claude Code JSON stdin/stdout protocol
│   │   ├── rank_session.go         #   Session ranking hook handler
│   │   ├── registry.go             #   Hook registration & dispatch
│   │   ├── session_end.go          #   Cleanup, rank submission
│   │   ├── session_start.go        #   Project info, config validation
│   │   ├── stop.go                 #   Loop controller
│   │   ├── subagent_start.go       #   Subagent start hook handler
│   │   ├── task_completed.go       #   Task completed hook handler
│   │   ├── teammate_idle.go        #   Teammate idle hook handler
│   │   ├── types.go                #   Hook type definitions
│   │   ├── user_prompt_submit.go   #   User prompt submit hook handler
│   │   ├── worktree_create.go      #   Worktree create lifecycle hook
│   │   └── worktree_remove.go      #   Worktree remove lifecycle hook
│   ├── i18n/                       # Internationalization (3 files)
│   │   └── templates.go            #   Translation templates for supported languages
│   ├── loop/                       # Ralph feedback loop
│   │   ├── controller.go
│   │   ├── feedback.go
│   │   ├── state.go
│   │   └── storage.go
│   ├── lsp/                        # Custom LSP client implementation
│   │   ├── client.go
│   │   ├── doc.go
│   │   ├── models.go
│   │   ├── protocol.go
│   │   └── server.go
│   ├── manifest/                   # File provenance tracking
│   │   ├── hasher.go               #   SHA-256 file hashing
│   │   ├── manifest.go             #   Manifest CRUD (.moai/manifest.json)
│   │   └── types.go                #   FileProvenance enum
│   ├── merge/                      # Smart merge engine
│   │   ├── conflict.go             #   Conflict detection & reporting
│   │   ├── differ.go               #   Diff generation
│   │   ├── strategies.go           #   Per-filetype merge strategies
│   │   ├── three_way.go            #   3-way merge algorithm
│   │   └── types.go                #   Merge type definitions
│   ├── ralph/
│   │   └── engine.go               #   Decision engine for loop iterations
│   ├── rank/                       # Performance ranking
│   │   ├── auth.go
│   │   ├── client.go
│   │   └── config.go
│   ├── resilience/                 # Retry and error recovery (11 files)
│   │   ├── circuit.go              #   Circuit breaker pattern
│   │   ├── health.go               #   Health check monitoring
│   │   ├── monitor.go              #   Resilience metrics monitoring
│   │   └── retry.go                #   Retry with exponential backoff
│   ├── statusline/                 # Statusline rendering
│   │   ├── builder.go
│   │   ├── git.go
│   │   ├── memory.go
│   │   ├── metrics.go
│   │   ├── renderer.go
│   │   ├── types.go                #   Statusline type definitions
│   │   └── update.go
│   ├── shell/                      # Shell environment detection (9 files)
│   │   ├── detect.go               #   Shell type detection (bash, zsh, fish)
│   │   └── env.go                  #   Shell environment variable management
│   ├── template/                   # Template deployment
│   │   ├── deployer.go             #   go:embed extraction with manifest
│   │   ├── deployer_mode.go        #   Model policy application to agent definitions
│   │   ├── errors.go               #   Template error types
│   │   ├── model_policy.go         #   Per-agent model assignment (high/medium/low)
│   │   ├── renderer.go             #   Go text/template strict rendering
│   │   ├── settings.go             #   Platform-aware settings.json generation
│   │   ├── validator.go            #   Post-deployment validation
│   │   └── templates/              #   go:embed source (bundled into binary)
│   │       ├── .claude/            #       Agent definitions, skills, commands, rules
│   │       ├── .moai/              #       Config section templates
│   │       └── CLAUDE.md           #       CLAUDE.md template
│   ├── tmux/                       # Tmux split-pane integration (6 files)
│   │   └── session.go              #   Tmux session management for CG mode
│   ├── ui/                         # Charmbracelet TUI
│   │   ├── checkbox.go             #   Multi-select with search
│   │   ├── headless.go             #   Non-interactive mode support
│   │   ├── progress.go             #   Progress bars + spinners
│   │   ├── prompt.go               #   Confirm/input prompts
│   │   ├── runner.go               #   TUI program runner
│   │   ├── selector.go             #   Fuzzy single-select
│   │   ├── theme.go                #   MoAI color theme (lipgloss)
│   │   ├── ui.go                   #   UI package entry point
│   │   └── wizard.go               #   Init wizard (bubbletea Elm model)
│   ├── workflow/                   # Workflow state management (6 files)
│   │   └── state.go                #   Workflow phase and SPEC state tracking
│   └── update/                     # Self-update system
│       ├── checker.go              #   GitHub Releases API version check
│       ├── orchestrator.go         #   Full update workflow coordinator
│       ├── rollback.go             #   Atomic rollback on failure
│       ├── types.go                #   Update type definitions
│       └── updater.go              #   Binary self-replacement
├── pkg/
│   ├── models/
│   │   ├── config.go
│   │   ├── doc.go                 #   Package documentation
│   │   ├── lang.go                #   Language support (LangNameMap, GetLanguageName)
│   │   └── project.go
│   ├── utils/
│   │   ├── logger.go
│   │   └── path.go
│   └── version/
│       ├── doc.go                 #   Package documentation
│       └── version.go
├── go.mod
├── go.sum
├── Makefile
├── CHANGELOG.md
└── .goreleaser.yml
```

---

## New Modules (Issue-Driven Design)

These modules are new additions to the Go edition, designed to resolve specific pain points from the Python predecessor. Each module cites the GitHub issues it addresses.

### `internal/hook/` -- Compiled Hook System

**Resolves**: 28 hook issues (#129, #259, #265, #269, #278, #288, etc.)

**Design**: Instead of 46 separate Python scripts, hooks are compiled into the moai binary as subcommands.

```json
{
  "hooks": {
    "SessionStart": [{ "hooks": [{ "type": "command", "command": "moai hook session-start" }] }],
    "PostToolUse":  [{ "matcher": "Write|Edit", "hooks": [{ "type": "command", "command": "moai hook post-tool" }] }]
  }
}
```

**Root causes eliminated**:
- Python runtime dependency (PyYAML, import errors) -- single binary, zero deps
- Path resolution ($CLAUDE_PROJECT_DIR, mixed separators) -- `moai` in PATH, no paths needed
- Platform incompatibility (SIGALRM, cp949 encoding) -- Go cross-compile, UTF-8 native
- Hook format errors -- programmatic settings.json generation

| File | Purpose | Replaces (Python) |
|------|---------|-------------------|
| `registry.go` | Hook event dispatch and registration | `jit_enhanced_hook_manager.py` (1,988 LOC) |
| `protocol.go` | Claude Code JSON stdin/stdout protocol | `lib/models.py`, `lib/common.py` |
| `contract.go` | Hook execution contract: guaranteed env vars, stdin format, exit codes, timeout behavior | -- (NEW: prevents regression) |
| `session_start.go` | Project info, config validation | `session_start__show_project_info.py` |
| `pre_tool.go` | Security guard, input validation | `pre_tool__security_guard.py` |
| `post_tool.go` | Linter, formatter, LSP diagnostics | `post_tool__linter.py`, `post_tool__code_formatter.py`, `post_tool__lsp_diagnostic.py` |
| `session_end.go` | Cleanup, rank submission | `session_end__auto_cleanup.py`, `session_end__rank_submit.py` |
| `stop.go` | Loop controller | `stop__loop_controller.py` |
| `compact.go` | Context preservation | `pre_compact__save_context.py` |

### `internal/manifest/` -- File Provenance Tracking

**Resolves**: 6 destructive overwrite issues (#162, #187, #236, #246, #318, #319)

Tracks every deployed file's origin, template hash, and current hash in `.moai/manifest.json`:

```json
{
  "version": "1.14.0",
  "files": {
    ".claude/agents/moai/expert-backend.md": {
      "provenance": "template_managed",
      "template_hash": "sha256:abc...",
      "deployed_hash": "sha256:abc...",
      "current_hash": "sha256:abc..."
    }
  }
}
```

| Provenance | Meaning | Update Behavior |
|-----------|---------|-----------------|
| `template_managed` | Deployed from template, no user changes | Safe overwrite |
| `user_modified` | Template base + user edits detected | 3-way merge |
| `user_created` | User's own file, not from template | Never touch |
| `deprecated` | Removed from new template version | Notify user, keep file |

| File | Purpose |
|------|---------|
| `manifest.go` | CRUD operations for .moai/manifest.json |
| `hasher.go` | SHA-256 file hashing for change detection |
| `types.go` | FileProvenance enum and manifest data structures |

### `internal/merge/` -- Smart Merge Engine

**Resolves**: 15 update/migration issues (#246, #187, #318, etc.)

Implements Git-like 3-way merge for safe template updates:

```
Base (last deployed template) ─── Current (user's file) ─── New (updated template)
                                        │
                                 3-way diff + merge
                                        │
                                  Merge Result (or .conflict file)
```

| File | Purpose |
|------|---------|
| `three_way.go` | Core 3-way merge algorithm |
| `strategies.go` | Per-filetype merge strategies (CLAUDE.md preserves sections, .gitignore merges entries, YAML deep merge) |
| `conflict.go` | Conflict detection, .conflict file generation, user notification |
| `differ.go` | Line-level and block-level diff generation |

### `internal/update/` -- Self-Update System

**Resolves**: 4 package manager issues (#253, #296, #159, #312)

Eliminates pip/uv/pipx dependency chain with binary self-replacement:

```
moai update
  → Check GitHub Releases API
  → Download platform binary to temp
  → Extract new templates (go:embed)
  → Run smart merge (manifest + 3-way)
  → Atomic binary replacement (write temp → rename)
  → Verify new binary runs
  → On failure: rollback to previous
```

| File | Purpose |
|------|---------|
| `checker.go` | GitHub Releases API version checking |
| `updater.go` | Binary download and self-replacement |
| `rollback.go` | Atomic rollback on failure (keeps previous binary) |
| `orchestrator.go` | Full update workflow: check → download → merge → replace → verify |

### `internal/template/` -- Template Deployment (Improved)

**Resolves**: 6 template substitution issues (#304, #308, #309, etc.)

Python's `{{VAR}}` substitution caused JSON parsing errors (template processor modified 28 times). Go solution:

| Approach | Python (broken) | Go (fixed) |
|----------|----------------|------------|
| Config files | `{{CONVERSATION_LANGUAGE}}` in YAML | Programmatic struct generation |
| settings.json | `{{HOOK_SHELL_PREFIX}}...{{HOOK_SHELL_SUFFIX}}` | Platform-aware Go code generation |
| CLAUDE.md | `{{PROJECT_DIR}}` replacement | Go `text/template` with strict mode |

| File | Purpose |
|------|---------|
| `deployer.go` | Extract templates from go:embed, write with manifest tracking |
| `renderer.go` | Go `text/template` with strict mode (errors on missing keys) |
| `settings.go` | Programmatic settings.json generation -- no template variables |
| `validator.go` | Post-deployment validation: path normalization, JSON validity check, agent file integrity | -- (NEW: prevents slash-missing bugs) |

---

## Directory Purpose and Go Conventions

### `cmd/` -- Application Entry Points

**Go Convention**: The `cmd/` directory contains the `main` packages for the application. Each subdirectory produces one binary.

```
cmd/
└── moai/
    └── main.go    # package main; func main()
```

`main.go` is intentionally thin. It initializes the root Cobra command, wires up dependencies, and calls `Execute()`. All logic lives in `internal/` or `pkg/`.

### `internal/` -- Private Application Packages

**Go Convention**: Go's compiler enforces that packages under `internal/` cannot be imported by code outside the module's own tree. This is a language-level privacy boundary, not just a convention.

#### `internal/cli/` -- CLI Command Layer (Cobra)

Defines all CLI commands using the Cobra library. Each file registers one command (or command group) with the root command.

| File | Purpose | Python Equivalent | Issues Addressed |
|------|---------|-------------------|------------------|
| `root.go` | Root command, global flags, version display | `cli/main.py` | -- |
| `init.go` | Project initialization wizard (bubbletea) | `cli/commands/init_command.py` | #2, #9, #256, #310 |
| `doctor.go` | System diagnostics and health checks | `cli/commands/doctor_command.py` | -- |
| `status.go` | Project status overview | `cli/spec_status.py` | -- |
| `update.go` | Self-update with smart merge | `cli/commands/update_command.py` | #246, #187, #318 |
| `hook.go` | Hook dispatcher (`moai hook <event>`) | -- (NEW) | All 28 hook issues |
| `switch.go` | Branch switching with context | `cli/commands/switch_command.py` | -- |
| `rank.go` | Performance ranking commands | `cli/commands/rank_command.py` | -- |
| `worktree/` | Git worktree management subcommands | `cli/worktree/` | #270 |

#### `internal/config/` -- Configuration Management (Custom YAML Loader + Typed Structs)

Thread-safe configuration loading with compile-time type safety. No template variable substitution in config files.

| File | Purpose | Python Equivalent | Issues Addressed |
|------|---------|-------------------|------------------|
| `manager.go` | Central config with sync.RWMutex | `core/config/unified.py` | #315, #283 |
| `types.go` | Config struct definitions with default tags | -- (NEW) | #206, #245, #243 |
| `defaults.go` | Compiled default values (no runtime file) | -- (NEW) | #221, #250 |
| `migration.go` | Legacy format migration (JSON → YAML sections) | `core/config/migration.py` | #307 |
| `validation.go` | Schema validation via struct tags | -- (NEW) | #226, #304 |

#### `internal/core/` -- Core Business Logic Domains

Contains the primary domain packages, each encapsulating a bounded context.

**`internal/core/project/`** -- Project Domain

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `initializer.go` | Project scaffolding with TTY detection | `core/project/initializer.py` |
| `detector.go` | Project type and language detection | `core/project/detector.py` |
| `validator.go` | Project structure validation | `core/project/validator.py` |
| `phase.go` | Phase execution (plan/run/sync) | `core/project/phase_executor.py` |

**`internal/core/git/`** -- Git Domain (system Git via exec only)

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `manager.go` | Central Git manager, repository access | `core/git/manager.py` |
| `branch.go` | Branch CRUD and naming conventions | `core/git/branch.py`, `branch_manager.py` |
| `conflict.go` | Pre-merge conflict detection | `core/git/conflict_detector.py` |
| `event.go` | Git event detection and hook integration | `core/git/event_detector.py` |

**`internal/core/quality/`** -- Quality Domain (TRUST 5)

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `trust.go` | TRUST 5 orchestrator and gate logic | `core/quality/trust_checker.py` |
| `validators.go` | Individual principle validators | `core/quality/validators/` |

**`internal/core/integration/`** -- Integration Testing Domain

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `engine.go` | Integration test execution engine | `core/integration/engine.py` |
| `models.go` | Test result models and reporting | `core/integration/models.py` |

**`internal/core/migration/`** -- Version Migration Domain

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `migrator.go` | Version migration orchestrator | `core/migration/version_migrator.py` |
| `backup.go` | Backup creation and restoration | `core/migration/backup_manager.py` |

#### `internal/foundation/` -- Foundation Methodologies

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `ears.go` | EARS requirement pattern templates | `foundation/ears.py` |
| `langs.go` | Language ecosystem definitions (16+ languages) | `foundation/langs.py` |
| `backend.go` | Backend architecture patterns | `foundation/backend.py` |
| `frontend.go` | Frontend architecture patterns | `foundation/frontend.py` |
| `database.go` | Database patterns and strategies | `foundation/database.py` |
| `testing.go` | Testing strategy definitions | `foundation/testing.py` |
| `devops.go` | DevOps and CI/CD patterns | `foundation/devops.py` |
| `trust/principles.go` | TRUST 5 principle definitions | `foundation/trust5.py` |
| `trust/checklist.go` | Quality checklist generation | `foundation/trust5.py` |

#### `internal/lsp/` -- Language Server Protocol

Custom LSP client supporting 16+ language servers via JSON-RPC 2.0.

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `client.go` | LSP client with connection management | `lsp/client.py` |
| `server.go` | Language server lifecycle management | `lsp/server_manager.py` |
| `protocol.go` | JSON-RPC 2.0 message encoding/decoding | `lsp/protocol.py` |
| `models.go` | LSP types (Diagnostic, Position, Range) | `lsp/models.py` |

#### `internal/loop/` -- Ralph Feedback Loop

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `controller.go` | Loop orchestration and convergence detection | `loop/controller.py` |
| `feedback.go` | Feedback collection from build/test/lint | `loop/feedback.py` |
| `state.go` | State machine definitions and transitions | `loop/state.py` |
| `storage.go` | Persistent loop state storage | `loop/storage.py` |

#### `internal/ralph/` -- Ralph Engine

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `engine.go` | Decision engine for loop iterations | `ralph/engine.py` |

#### `internal/rank/` -- Performance Ranking

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `client.go` | Ranking API HTTP client | `rank/client.py` |
| `auth.go` | API authentication and credentials | `rank/auth.py` |
| `config.go` | Ranking configuration | `rank/config.py` |
| `hook.go` | Git hook integration for metrics | `rank/hook.py` |

#### `internal/statusline/` -- Statusline Rendering

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `builder.go` | Statusline composition and layout | `statusline/main.py` |
| `git.go` | Git status data collection | `statusline/git_collector.py` |
| `metrics.go` | Performance metrics aggregation | `statusline/metrics_tracker.py` |
| `memory.go` | Memory and token usage collection | `statusline/memory_collector.py` |
| `renderer.go` | Terminal output rendering | `statusline/renderer.py` |
| `update.go` | Version update checking | `statusline/update_checker.py` |

#### `internal/astgrep/` -- AST-Grep Integration

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `analyzer.go` | AST pattern analysis orchestrator | `astgrep/analyzer.py` |
| `models.go` | AST match result models | `astgrep/models.py` |
| `rules.go` | Custom rule definitions and loading | `astgrep/rules.py` |

#### `internal/ui/` -- Terminal UI (Charmbracelet Ecosystem)

Modern TUI using Charmbracelet's Elm-architecture framework. Replaces Rich + InquirerPy.

**Resolves**: #268 (ESC freeze), #249 (encoding), #286 (Windows emoji)

| File | Purpose | Python Equivalent |
|------|---------|-------------------|
| `wizard.go` | Init wizard (bubbletea Elm model) | `cli/prompts/init_prompts.py` |
| `selector.go` | Fuzzy single-select with filtering | InquirerPy `fuzzy_select()` |
| `checkbox.go` | Multi-select with search | InquirerPy `fuzzy_checkbox()` |
| `progress.go` | Progress bars + spinners (bubbles) | Rich `Progress()` |
| `theme.go` | MoAI color theme (lipgloss) | `cli/ui/theme.py` |
| `prompt.go` | Confirm/input prompts (huh) | `cli/ui/prompts.py` |

### `pkg/` -- Public Packages

**Go Convention**: Packages importable by external projects. Stable public API.

#### `pkg/version/`

Version constants and build metadata injected at compile time via `-ldflags`. No runtime version file needed (resolves #221, #250).

| File | Purpose |
|------|---------|
| `doc.go` | Package documentation |
| `version.go` | Version constants and build metadata |

#### `pkg/models/`

| File | Purpose |
|------|---------|
| `config.go` | Configuration section types (LSP, TRUST5, Quality gates) |
| `doc.go` | Package documentation |
| `lang.go` | Language support utilities (LangNameMap, SupportedLanguages, GetLanguageName, IsValidLanguageCode) |
| `project.go` | Project metadata, type enums, configuration models |
| `spec.go` | SPEC document models, status enums |

#### `pkg/utils/`

| File | Purpose |
|------|---------|
| `logger.go` | Structured logging via `log/slog` |
| `file.go` | File system helpers (safe write, atomic operations) |
| `path.go` | Path resolution, `.moai/` directory discovery |
| `timeout.go` | Context-based timeout utilities |
| `validator.go` | Input validation helpers |

### `internal/template/templates/` -- Embedded Templates

**Go Feature**: Go 1.16's `embed` package bundles all templates into the compiled binary. Version-matched deployment guaranteed (resolves #307).

```
internal/template/templates/
├── .claude/
│   ├── agents/moai/           # Agent definitions (markdown)
│   ├── skills/                # Skill definitions (YAML frontmatter + markdown)
│   ├── commands/moai/         # Slash commands
│   ├── rules/moai/            # Rule files (core, workflow, development, language)
│   └── output-styles/         # Output style configurations
├── .moai/
│   └── config/sections/       # Config section templates (YAML)
└── CLAUDE.md                  # CLAUDE.md template
```

### Root Files

| File | Purpose |
|------|---------|
| `go.mod` | Go module definition (`github.com/modu-ai/moai-adk`) |
| `go.sum` | Cryptographic checksums of dependencies |
| `Makefile` | Build, test, lint, and release automation |
| `CHANGELOG.md` | Version history following Keep a Changelog format |
| `.goreleaser.yml` | Cross-platform release configuration (6 platform targets) |

---

## Data Flow

### CLI Command Execution Flow

```
User Input
    |
    v
cmd/moai/main.go          -- Cobra root command
    |
    v
internal/cli/*.go          -- Command handler
    |
    v
internal/config/manager.go -- Load typed configuration
    |
    v
internal/core/*/           -- Domain logic execution
    |                           |
    v                           v
internal/lsp/              internal/core/git/
(LSP diagnostics)          (Git operations)
    |                           |
    +---------------------------+
    |
    v
internal/ui/               -- Render output (bubbletea/lipgloss)
    |
    v
Terminal (stdout/stderr)
```

### Hook Execution Flow (NEW)

```
Claude Code Event (e.g., PostToolUse)
    |
    v
Claude Code reads .claude/settings.json
    |
    v
Spawns subprocess: "moai hook post-tool"
    |
    v
internal/cli/hook.go       -- Route to hook handler
    |
    v
internal/hook/protocol.go  -- Parse JSON from stdin
    |
    v
internal/hook/contract.go -- Validate execution contract
    |  ├── Verify stdin JSON validity
    |  ├── Verify working directory exists
    |  └── Log environment state (debug level)
    |
    v
internal/hook/post_tool.go -- Execute hook logic
    |  ├── Read config (same binary, same loader)
    |  ├── Run linter checks
    |  ├── Collect LSP diagnostics
    |  └── Format output
    |
    v
stdout (JSON result) + exit code (0=allow, 2=block)
    |
    v
Claude Code processes result
```

### Smart Update Flow (NEW)

```
moai update
    |
    v
internal/update/checker.go     -- Check GitHub Releases API
    |
    v
internal/update/updater.go     -- Download new binary to temp
    |
    v
internal/manifest/manifest.go  -- Load current file manifest
    |
    v
internal/template/deployer.go  -- Extract new templates from binary
    |
    v
For each template file:
    |
    ├── template_managed + no changes → Overwrite
    ├── template_managed + changed    → Promote + 3-way merge
    ├── user_modified                 → 3-way merge
    ├── user_created                  → Skip
    └── deprecated                    → Notify, keep
    |
    v
internal/merge/three_way.go    -- Merge with conflict detection
    |
    v
internal/manifest/manifest.go  -- Update manifest hashes
    |
    v
internal/update/updater.go     -- Atomic binary replacement
    |
    v
internal/update/rollback.go    -- On failure: restore previous
    |
    v
internal/ui/progress.go        -- Show summary (updated/merged/conflicted/skipped)
```

### Quality Gate Flow

```
Code Change (post-implementation)
    |
    v
internal/core/quality/trust.go    -- TRUST 5 orchestrator
    |
    +-- Tested    --> internal/lsp/ (type errors, test results)
    +-- Readable  --> internal/lsp/ (lint diagnostics)
    +-- Unified   --> internal/astgrep/ (pattern analysis)
    +-- Secured   --> internal/lsp/ (security warnings)
    +-- Trackable --> internal/core/git/ (commit format)
    |
    v
Quality Report (pass/fail with details)
```

### Feedback Loop Flow

```
SPEC Requirement
    |
    v
internal/loop/controller.go   -- Loop orchestration
    |
    v
internal/ralph/engine.go      -- Decision engine
    |
    +-- Analyze  --> Read code, identify gaps
    +-- Implement --> Generate changes
    +-- Test     --> Run tests, collect feedback
    +-- Review   --> Evaluate convergence
    |
    v
internal/loop/feedback.go     -- Collect results
    |
    v
internal/loop/state.go        -- Update state machine
    |
    v
Converged? --> Yes: Complete
             No:  --> Next iteration
```

---

## Integration Points

### External System Integration

| System | Protocol | Package | Purpose |
|--------|----------|---------|---------|
| Claude Code (hooks) | stdin JSON + exit codes | `internal/hook/` | Event-driven automation |
| Claude Code (files) | File system | `internal/cli/`, `internal/template/` | Agent/skill/command execution |
| Language Servers | JSON-RPC 2.0 (stdio/TCP) | `internal/lsp/` | Code diagnostics |
| Git | system Git via `exec.Command` | `internal/core/git/` | Version control |
| ast-grep | CLI subprocess | `internal/astgrep/` | Structural code analysis |
| Ranking API | HTTPS REST | `internal/rank/` | Performance metrics |
| GitHub Releases | HTTPS REST | `internal/update/` | Self-update |
| File system | OS syscalls | `pkg/utils/` | Configuration, templates |

### Internal Module Dependencies

```
cli/ ────────→ config/, core/*, hook/, update/, ui/, github/, tmux/
hook/ ───────→ config/, core/quality/, lsp/, loop/, resilience/
update/ ─────→ manifest/, merge/, template/
template/ ───→ manifest/
core/project/ → config/, core/git/, foundation/, defs/
core/quality/ → lsp/, astgrep/, core/git/
loop/ ────────→ ralph/, core/quality/, core/git/
statusline/ ──→ core/git/, config/, pkg/version/
rank/ ────────→ config/, core/git/
github/ ─────→ shell/, resilience/, workflow/
shell/ ──────→ (no internal deps)
resilience/ ─→ (no internal deps)
workflow/ ───→ config/, defs/
i18n/ ───────→ (no internal deps)
```

**Dependency Rule**: Dependencies flow downward and inward. `cli/` depends on everything; `pkg/` depends on nothing internal. Circular dependencies are prohibited.

---

## Architecture Decisions

### ADR-001: Modular Monolithic over Microservices

**Decision**: Single binary with internal module boundaries rather than separate services.

**Rationale**: MoAI-ADK is a developer tool, not a distributed system. A single binary simplifies distribution, eliminates IPC overhead, and enables atomic operations across domains.

### ADR-002: internal/ for Domain Encapsulation

**Decision**: All domain logic under `internal/` with minimal `pkg/` surface.

**Rationale**: Aggressive API minimization. Only `pkg/version/`, `pkg/models/`, and `pkg/utils/` are public. This allows refactoring internal implementations freely without semver concerns.

### ADR-003: Interface-Based Domain Boundaries

**Decision**: Each domain exposes a Go interface; consumers depend on the interface, not the struct.

**Rationale**: Enables testing with mocks, allows swapping implementations (system Git via exec in production, in-memory stubs in tests), and enforces DIP at compile time.

### ADR-004: Embedded Templates via go:embed

**Decision**: Bundle all Claude Code templates into the binary using `//go:embed` directives.

**Rationale**: Eliminates runtime file path dependencies, ensures template version consistency with the binary, and enables single-file distribution. Resolves version mismatch issues (#307).

### ADR-005: Structured Logging via log/slog

**Decision**: Use Go 1.21's standard `log/slog` package for all logging.

**Rationale**: No external dependency, structured JSON output for machine parsing, leveled logging.

### ADR-006: Hooks as Binary Subcommands (NEW)

**Decision**: Implement Claude Code hooks as `moai hook <event>` subcommands instead of separate script files.

**Rationale**: Eliminates Python runtime dependency (12 issues), path resolution failures (8 issues), and platform incompatibility (5 issues). Validated by cc-tools project. Total: 28 hook issues resolved.

**Evidence**: GitHub issues #129 (SIGALRM), #259 (path separators), #278 (PyYAML), #265 (format incompatible).

### ADR-007: File Manifest for Provenance Tracking (NEW)

**Decision**: Track every deployed file's origin, template hash, and current hash in `.moai/manifest.json`.

**Rationale**: Prevents destructive updates by distinguishing template-managed files from user customizations. Enables 3-way merge for safe updates. Resolves 6 destructive overwrite issues.

**Evidence**: GitHub issues #246 (settings lost), #187 (workflows overwritten), #162 (files overwritten), #236 (content deleted).

### ADR-008: 3-Way Merge for Template Updates (NEW)

**Decision**: Use Git-like 3-way merge (base, current, new) for template file updates instead of simple overwrite.

**Rationale**: Users customize template files (agents, skills, CLAUDE.md). Updates must preserve customizations while applying new template changes. Conflict detection generates `.conflict` files for manual resolution.

**Evidence**: update.py was the most modified file (38 times), indicating chronic merge problems.

### ADR-009: Self-Update via Binary Replacement (NEW)

**Decision**: Implement self-update by downloading new binary from GitHub Releases and atomic self-replacement.

**Rationale**: Eliminates dependency on pip/uv/pipx package managers. Atomic replacement with rollback ensures reliability. Single binary distribution = single update mechanism.

**Evidence**: GitHub issues #253 (PyPI missing), #296 (PATH issue), #159 (uv fails), #312 (uv update fails).

### ADR-010: Charmbracelet for Terminal UI (NEW)

**Decision**: Use bubbletea (TUI framework) and lipgloss (styling) from the Charmbracelet ecosystem.

**Rationale**: Elm-architecture model for predictable state management. Cross-platform terminal compatibility (Windows, macOS, Linux). UTF-8 native eliminates encoding issues (#249, #286, #314). Rich component library.

### ADR-011: Zero Runtime Template Expansion (NEW)

**Decision**: All configuration files (settings.json, config YAML, CLAUDE.md) are generated by Go struct serialization or Go `text/template` with strict mode. No file contains unexpanded dynamic tokens at rest.

**Rationale**: The Python predecessor suffered 4 regression cycles over 5 months (41+ commits) because settings.json contained template variables like `${SHELL:-/bin/bash}` and `{{HOOK_SHELL_PREFIX}}` that broke when Node.js (Claude Code runtime) attempted to execute them. JSON does not support variable expansion; Go struct serialization (json.Marshal) produces valid JSON by construction.

**Evidence**: PATH analysis identified commits 69d851c4 (literal ${SHELL} in JSON → ENOENT), 45e56dd7 and 058a9e46 (double quotes in PATH augmentation → JSON parse error), and the template processor being modified 28 times.

**Implementation**:
- `settings.json`: Generated by `internal/template/settings.go` via `json.MarshalIndent()` from Go structs
- Config YAML: Generated by `internal/config/manager.go` via `yaml.Marshal()` from typed structs
- CLAUDE.md: Generated by `internal/template/renderer.go` via Go `text/template` with `Option("missingkey=error")`
- Post-generation: `internal/template/validator.go` runs `json.Valid()` on all JSON output

### ADR-012: Hook Execution Contract (NEW)

**Decision**: Define a formal Hook Execution Contract in `internal/hook/contract.go` that specifies exactly what the Go binary guarantees and what it does NOT guarantee about the hook execution environment.

**Rationale**: The Python predecessor had no formal specification for hook execution environment. Each fix was ad-hoc, and every regression cycle introduced new edge cases (7 different approaches attempted: relative paths → environment variables → platform-specific → shell wrappers → compile-time → PATH augmentation → shell detection). A formal contract prevents regression by making expectations explicit and testable.

**Contract guarantees**:
- stdin: Valid JSON conforming to Claude Code hook protocol
- exit codes: 0 (allow/success), 2 (block), other (non-blocking error)
- timeout: Configurable via context.WithTimeout (default 30s)
- config access: Same binary, same config loader as CLI commands
- working directory: Project root ($CLAUDE_PROJECT_DIR)

**Contract does NOT guarantee**:
- User's PATH (hook runs as bare `moai` binary, must be in system PATH)
- Shell environment variables (.bashrc/.zshrc NOT loaded)
- Shell functions or aliases
- Python/Node.js/uv availability

**Testing**: `internal/hook/contract_test.go` simulates non-interactive shell execution via `exec.Command()` with minimal PATH, verifying the contract holds across platforms.

**Evidence**: Claude Code GitHub issues #7490 (63 upvotes, shell setup impossible), #5202 (PATH not inherited), #9633 (shell snapshot broken), #16602 (Windows cmd.exe execution).

---

## Non-Functional Requirements

### Performance

- CLI cold start: < 50ms
- Hook execution: < 100ms (compiled, no interpreter)
- Configuration load: < 10ms
- LSP server startup (per language): < 500ms
- Quality gate execution (full TRUST 5): < 5s
- Git operations (branch, status): < 100ms
- Self-update check: < 2s

### Reliability

- Graceful degradation when language servers are unavailable
- Automatic rollback on failed updates (ADR-009)
- Checkpoint-based recovery for interrupted operations
- Zero data loss guarantee for configuration changes
- Conflict detection prevents silent data loss (ADR-008)
- Hook execution contract validation on every invocation (< 1ms overhead)
- Post-deployment file validation prevents path normalization errors (slash-missing bugs)
- Zero regression guarantee: Hook contract tests run in CI on all 6 platform targets

### Cross-Platform

- macOS (arm64, amd64): Primary development platform
- Linux (arm64, amd64): CI/CD, containers, WSL2
- Windows (amd64, arm64): Full support, no SIGALRM/encoding issues
- CGO_ENABLED=0: Pure Go, no C dependencies

### Scalability

- Support projects with 10,000+ files
- Handle 16+ concurrent LSP server connections
- Process quality gates across repositories with 100+ modules

### Security

- No secrets stored in plaintext
- Credential management via system keyring
- Template injection prevention (Go text/template strict mode)
- Input validation on all CLI arguments
- OWASP compliance scanning via gosec
